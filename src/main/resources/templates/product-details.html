<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Product Details</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!--    <link rel="stylesheet" href="home.css"/>-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.js"
            integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
            integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            crossorigin="anonymous"></script>
    <style>
        .logout a:hover{
            color: white;
        }
        .wrapper {
            position: relative;
            overflow: hidden;
        }

        .wrapper:after {
            content: '';
            display: block;
            padding-top: 100%;
        }

        .wrapper img {
            width: auto;
            height: 100%;
            max-width: none;
            position: absolute;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
        }
        html,body {
            height: 100%;
            display: block;
            margin: 0;
            padding: 0;
        }
        /* The sticky class is added to the header with JS when it reaches its scroll position */
        .sticky {
            position: fixed;
            top: 0;
            width: 100%
        }
        .content {
            padding: 16px;
        }
        /* Add some top padding to the page content to prevent sudden quick movement (as the header gets a new position at the top of the page (position:fixed and top:0) */
        .sticky + .content {
            padding-top: 102px;
        }
        #myHeader{
            z-index: 100;
        }
        .user a{
            text-decoration: none;
            color: rgba(255,255,255,.5);
        }
        .user a:hover{
            color: #f8f9fa;
            text-decoration: none;
        }
        .dropdown-item:hover{
            background-color: #007bff;
        }
        #myHeader{
            z-index: 500;
        }

        .user i{
            color: rgba(255,255,255,.5);
        }
        .gallery-wrap .img-big-wrap img {

            width: 100%;
            display: inline-block;
            cursor: zoom-in;
        }


        .gallery-wrap .img-small-wrap .item-gallery {
            width: 60px;
            height: 60px;
            border: 1px solid #ddd;
            margin: 7px 2px;
            display: inline-block;
            overflow: hidden;
        }

        .gallery-wrap .img-small-wrap {
            text-align: center;
        }
        .gallery-wrap .img-small-wrap img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            border-radius: 4px;
            cursor: zoom-in;
        }
    </style>
    <script>
        $(function(){
            $("#header").load("header.html");
        });

    </script>
</head>
<body>
<nav id="header"></nav>
<br>  <p class="text-center">Shopping Center <a href="home"> Shopping-Center.com</a></p>
<hr>
<div class="container" id="product">
     <!-- card.// -->


</div>
<!--container.//-->
</body>
<script>
    var time = new Date();
    var year = time.toDateString();
    function getnum(c){
        var t= Number(c.replace(/[^0-9.-]+/g,""));

        if(isNumeric(t)){
            return parseInt(t,10);
        }
        return 0;
        function isNumeric(n) {
            return !isNaN(parseFloat(n)) && isFinite(n);
        }
    }
    function getq(c){
        if(isNumeric(c)){
            return parseInt(c,10);
        }
        return 0;
        function isNumeric(n) {
            return !isNaN(parseFloat(n)) && isFinite(n);
        }
    }
    async function load(){
     await   $.when($.get("http://localhost:8080/getCurrentUser").then(function (data){

            const object = JSON.parse(data);

            window.userinfo = object.id;

            $("#addressForm").on("submit", function (e){
                e.preventDefault();
            });

            var obj = JSON.parse(localStorage.getItem('product-detail'));
            window.obj = obj;
            // alert(JSON.stringify(obj));
            loadcart(obj);
            function loadcart(product) {
                var div = document.querySelector('#product');
                // data.forEach((product)=> {

                div.innerHTML =
                    div.innerHTML +
                    `<div class="card" id="${product.id}">
        <div class="row">
            <aside class="col-sm-5 border-right">
                <article class="gallery-wrap">
                    <div class="img-big-wrap">
                        <div> <a href="#"><img id="photo" src="${product.photo}"></a></div>
                    </div> <!-- slider-product.// -->
                    <div class="img-small-wrap">
                        <div class="item-gallery"> <img src="${product.photo}"> </div>
                        <div class="item-gallery"> <img src="${product.photo}"> </div>
                        <div class="item-gallery"> <img src="${product.photo}"> </div>
                        <div class="item-gallery"> <img src="${product.photo}"> </div>
                    </div> <!-- slider-nav.// -->
                </article> <!-- gallery-wrap .end// -->
            </aside>
            <aside class="col-sm-7">
                <article class="card-body p-5">
                    <h3 class="title mb-3" id="productName">${product.productName}</h3>

                    <p class="price-detail-wrap">
	<span class="price h3 text-warning">
		<span class="currency" id="price">${product.price}</span>
	</span>

                    </p> <!-- price-detail-wrap .// -->
                    <dl class="item-property">
                        <dt>Description</dt>
                        <dd><p id="productDescription">${product.description}</p></dd>
                    </dl>


                    <dl class="param param-feature">
                        <dt>Stock:</dt>
                        <dd>${product.stock}</dd>
                    </dl>  <!-- item-property-hor .// -->

                    <hr>
                    <div class="row">
                        <div class="col-sm-5">
                            <dl class="param param-inline">
                                <dt>Quantity: </dt>
                                <dd>
                                    <select id="quantity" class="form-control form-control-sm" style="width:70px;">
                                        <option> 1 </option>
                                        <option> 2 </option>
                                        <option> 3 </option>
                                    </select>
                                </dd>
                            </dl>  <!-- item-property .// -->
                        </div> <!-- col.// -->
                    </div> <!-- row.// -->
                    <hr>
                    <button data-toggle="modal" data-target="#addressPopUp" class="btn btn-lg btn-primary text-uppercase"> Buy now </button>
                    <div class="modal fade" id="addressPopUp" tabindex="-1" role="dialog" aria-labelledby="addressPopUp" aria-hidden="true">
                        <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Set your delivery address:</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="addressForm" >
                                    <div class="form-group row">
                                        <label for="addressInput" class="col-md-4 col-form-label">Delivery address:</label>
                                        <div class="col-md-7">
                                            <input type="text" class="form-control" id="addressInput" placeholder="Enter your desired delivery address" required/>
                                        </div>
                                    </div>

                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                        <button type="submit" id="checkout" class="btn btn-primary">Save changes</button>
                                    </div>
                                </form>



                            </div>

                        </div>
                    </div>
                    </div>
                    <button onclick="addToCart(${product.id})" id="${product.store_id}" class="addproduct btn btn-lg btn-outline-primary text-uppercase"> <i class="fas fa-shopping-cart"></i> Add to cart </button>
                </article> <!-- card-body.// -->
            </aside> <!-- col.// -->
        </div> <!-- row.// -->
    </div>`;
                // });
            }


        }));
    }



    load().then(function (){
        $("#checkout").click(function (e){

            e.preventDefault();
            const buyNow = [];
            // if($("#addressInput").val()!== ""){
            // for(var i = 0; i < window.obj.length; i++){


            const product = {
                "user": {"id": getq(window.userinfo)},
                "product": {"id": getq(window.obj.id)},
                "quantity": getq($("#quantity").val()),
                "storeId": getq(window.obj.store_id),
                "address": $("#addressInput").val(),
                "time": year
            };
            // alert(window.obj[i].store_id);
            buyNow.push(product);


            // };
            // alert(JSON.stringify(buyNow));
            $.ajax({
                url: "http://localhost:8080/api/basketCheckout",
                contentType: 'application/json ; charset = utf-8',
                type: "POST",
                data: JSON.stringify(buyNow),
                success: function(e){
                    alert(JSON.stringify(e));

                    localStorage.removeItem(window.userinfo);
                    window.location.href = "profile";

                },
                error: function(jqXHR, textStatus, errorThrown) {
                    alert(JSON.stringify(jqXHR));
                }
            });

            // }
        });
    })


    function addToCart(clicked_id)
    {

        // $.get("http://localhost:8080/getCurrentUser", function (data){
            var currentuser = window.userinfo;
            // const object = JSON.parse(data);
            // currentuser = object.id;
            // alert(currentuser);
            var qselector = "#" + clicked_id.toString() + " " + "#quantity";
            var pnselector = "#" + clicked_id.toString() + " " + "#productName";
            var pselector = "#" + clicked_id.toString() + " " + "#price";
            var imgselector = "#" + clicked_id.toString() + " " + "#photo";
            var btnselector = "#" + clicked_id.toString() + " " + ".addproduct";
            console.log(btnselector);
            // save the value of #checkbox-1 as a variable,
            var productName = $(pnselector).text();
            var quantity = $(qselector).val();
            var price = $(pselector).text();
            var photo = $(imgselector).attr('src');
            var store = $(btnselector).attr('id');
            console.log(store);
            // and test it to confirm it worked.
            const jsonData = {
                id: clicked_id.toString(),
                productName: productName.toString(),
                quantity: quantity.toString(),
                price: price.toString(),
                photo: photo.toString(),
                store_id: store.toString()
            };
            if(!localStorage.getItem(currentuser)){
                localStorage.setItem(currentuser, "[]");
            }
            var list = JSON.parse(localStorage.getItem(currentuser));
            var exist = false;
            for(var i = 0; i < list.length; i++){
                if(list[i].id === jsonData.id) {
                    var newquantity = parseInt(jsonData.quantity) + parseInt(list[i].quantity);
                    list[i].quantity = newquantity.toString();
                    exist = true;
                    break;
                }
                else{


                }
            }

            if(!exist) {list.push(jsonData); alert("Successfully Add to Cart");}
            else{
                alert("Your Cart is Updated");
            }

            localStorage.setItem(currentuser, JSON.stringify(list));

        // });
    }
</script>
</html>